{% extends "base.html" %}

{% block head %}
    <title>Battleship</title>
    <meta charset="utf-8">

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Loved+by+the+King&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/game.css">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="math.js" type="text/javascript"></script>
{% endblock %}

{% block page_content %}

    <main>
        <div class="row">
            <div class="col-md-2"></div>

            <section class="col-sm-12 col-md-4" class="board" id="left_board">
                <div class="board">
                    {% for n in range(100) %}
                        <div id="b1_square{{n}}" class="square"></div>
                    {% endfor %}
                </div>
            </section>

            <section class="col-sm-12 col-md-4" class="board" id="right_board">
                <div class="board">
                    {% for n in range(100) %}
                        <div id="b2_square{{n}}" class="square"></div>
                    {% endfor %}
                </div>
            </section>

            <div class="col-md-2"></div>
        </div>

        <div class="row">
            <div class="col-md-2"></div>

            <div class="col-md-8">
                <section id="gamepanel">
                    <div class="row">
                        <article class="col-md-3">
                            <div class="panel_element">
                                current player: <span id='player'></span>
                            </div>
                        </article>

                         <article class="col-md-3">
                            <div class="panel_element">
                                <button type="button" id="player_swap" onclick="switch_player()">Zmień gracza</button>
                            </div>
                        </article>

                        <article class="col-md-3 ">
                            <div  class="panel_element">
                                <button type="button" id="game_trigger" onclick="start_game()">Rozpocznij Grę</button>
                            </div>
                        </article>
                        
                        <article class="col-md-3">
                            <div class="panel_element">
                                <button type="button" id="ship_relocation">Rozstaw statki</button>
                            </div>
                        </article>
                    </div>
                </section>
            </div>

            <div class="col-md-2"></div>
        </div>
    </main>

    <script>

        var game_started = false;
        var player_moved = false;
        
        var player = 1;

        // liczba celnych strzałów oddanych prze danego gracza
        var player_one_points = 0;
        var player_two_points = 0;
        
        // uchwyty dla pól jako elementów DOM
        var b1_square = [];
        var b2_square = [];

        // numery pól, na których znajdują się statki
        var b1_ships = [];
        var b2_ships = [];

        $('#player').html(player);

        // początkowe rozstawienie statków dla obu graczy
        set_ships(1);
        set_ships(2);

        var ship_relocation = document.getElementById('ship_relocation');
        ship_relocation.addEventListener("click", () => { set_ships(player); });
        
        function start_game() {
            game_started = true;

            // przypisz do wszystkich pól gracza nr 1 funkcję handle_clicked_field(nr)
            for (let i = 0; i < 100; i++) {
                b1_square[i] = document.getElementById('b1_square' + i);
                b1_square[i].addEventListener("click", () => { handle_clicked_field(i); });
            }

            // przypisz do wszystkich pól gracza nr 2 funkcję handle_clicked_field(nr)
            for (let i = 0; i < 100; i++) {
                b2_square[i] = document.getElementById('b2_square' + i);
                b2_square[i].addEventListener("click", () => { handle_clicked_field(i); });
            }

            // wyszarzanie przycisków 'rozpocznij grę' i 'rozstaw statki'
            $('#game_trigger').attr('readonly', 'true');
            $('#ship_relocation').attr('readonly', 'true');

            $('#game_trigger').css('opacity', '0.75');
            $('#ship_relocation').css('opacity', '0.75');

            $('#game_trigger').css('pointer-events', 'none');
            $('#ship_relocation').css('pointer-events', 'none');
            
            if (player == 2) {
                player = 1;
                $('#player').html(player);
            }

            disable_board('1');
        }

        // rozmieszcza statki na wybranej planszy
        function set_ships(board_nr) {
            if (board_nr == 1) {
                for (let i = 0; i < 35; i++) {
                    b1_ships[i] = get_random_int(0, 99);
                }
            } else if (board_nr == 2) {
                for (let i = 0; i < 35; i++) {
                    b2_ships[i] = get_random_int(0, 99);
                }
            }
        }

        // obsługuje naciśnięcie danego pola
        function handle_clicked_field(nr) {
            if (player == 1) {
                if (b2_ships.includes(nr)) { // przypadek, w którym gracz nr 1 trafił
                    player_one_points++;
                    flip_success(nr);
                } else { // przypadek, w którym gracz nr 1 spudłował
                    flip_failure(nr);
                }
                disable_board('2');
            } else if (player == 2) { // przypadek, w którym gracz nr 2 trafił
                if (b1_ships.includes(nr)) {
                    player_two_points++;
                    flip_success(nr);
                } else { // przypadek, w którym gracz nr 2 spudłował
                    flip_failure(nr);
                }
                disable_board('1');
            }
        }

        // wywoływana w przypadku celnego strzału
        function flip_success(nr) {
            var id_prefix = set_prefix();

            $('#' + id_prefix + nr).removeClass('square');
            $('#' + id_prefix + nr).addClass('square_success');

            if (player_one_points == 2 || player_two_points == 2) {
                end_game();
            }
        }

        // wywoływana w przypadku spudłowania
        function flip_failure(nr) {
            var id_prefix = set_prefix();

            $('#' + id_prefix + nr).removeClass('square');
            $('#' + id_prefix + nr).addClass('square_fail');
        }

        // zamień aktualnego gracza
        function switch_player() {
            var board_to_enable = player;
            
            player = (player == 1 ? 2 : 1);
            $('#player').html(player);

            enable_board(String(board_to_enable));
        }

        // blokuje możliwość oddania strzału na danej planszy
        function disable_board(nr) {
            for (let i = 0; i < 100; i++) {
                $("#b" + nr + "_square" + i).css("pointer-events", "none");
            }
        }

        // umożliwia oddawanie strzałów na danej planszy
        function enable_board(nr) {
            for (let i = 0; i < 100; i++) {
                $("#b" + nr + "_square" + i).css("pointer-events", "auto");
            }
        }

        function end_game(player) {
            // wyszarzanie przycisku 'zamień gracza'
            $('#player_swap').attr('readonly', 'true');
            $('#player_swap').css('opacity', '0.75');
            $('#player_swap').css('pointer-events', 'none');
            
            if (player_one_points == 2) {
                alert("Zwycięża gracz 1");
            } else if (player_two_points == 2) {
                alert("Zwycięża gracz 2");
            }

            // zablokowanie obu planszy
            () => {
                disable_board('1');
                disable_board('2');
            }
        }

        // ustawianie odpowiedniego przedrostka dla uchwytów w jQuery
        function set_prefix() {
            return (player == 1 ? "b2_square" : "b1_square");
        }

        function get_random_int(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min)) + min;
        }

    </script>

{% endblock %}